name: üñ•Ô∏è REMOTE DESKTOP SERVICES

on:
  workflow_dispatch:
    inputs:
      os_version:
        description: 'üìÄ Select Operating System'
        required: true
        default: 'Windows Server 2025 (Native - 4vCPU | 16GB RAM)'
        type: choice
        options:
          - "Windows 10 Professional (Docker - 4vCPU | 8GB RAM)"
          

jobs:
  # ==================== JOB 1: WINDOWS SERVER 2025 NATIVE ====================
  windows-server-2025-native:
    name: "Windows Server 2025 Native (#${{ matrix.instance }})"
    if: github.event.inputs.os_version == 'Windows Server 2025 (Native - 4vCPU | 16GB RAM)'
    runs-on: windows-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        instance: [1,2,3,4,5,6,7,8,9,10]

    env:
      INSTANCE: ${{ matrix.instance }}

    steps:
      - name: üîß Initializing Windows Server 2025 (Native)
        run: |
          $ErrorActionPreference = 'SilentlyContinue'

          # Create Administrator Account
          net user user ngoc0102@ /add /expires:never /passwordchg:no
          net localgroup Administrators user /add
          net localgroup "Remote Desktop Users" user /add

          # Configure RDP Service
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 profile=any

          # Start Kami Tunnel
          Start-Process powershell -ArgumentList "-NoProfile -Command `
            iwr https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz -OutFile kami-tunnel-windows-amd64.tar.gz; `
            tar -xzf kami-tunnel-windows-amd64.tar.gz; `
            .\kami-tunnel.exe 3389"

      - name: üåê Connection Information - Windows Server 2025
        run: |
          Write-Host "üß© INSTANCE: $env:INSTANCE" -ForegroundColor Yellow
          Write-Host "üîÑ Establishing connection to Windows Server 2025..." -ForegroundColor Cyan
          $ip = ""
          while (-not $ip) {
              if (Test-Path "kami_tunnel.txt") {
                  $content = Get-Content "kami_tunnel.txt"
                  if ($content -match '\.') { $ip = $content }
              }
              if (-not $ip) { Start-Sleep -Seconds 3 }
          }

          Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
          Write-Host "‚ïë      ‚úÖ WINDOWS SERVER 2025 - READY FOR CONNECTION        ‚ïë" -ForegroundColor Green
          Write-Host "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£" -ForegroundColor White
          Write-Host "‚ïë üß©  Instance    : $env:INSTANCE" -ForegroundColor Yellow
          Write-Host "‚ïë üåê  Public IP   : $ip" -ForegroundColor Yellow
          Write-Host "‚ïë üë§  Username    : Admin" -ForegroundColor White
          Write-Host "‚ïë üîê  Password    : Window@123456" -ForegroundColor White
          Write-Host "‚ïë üìç  RDP Port    : 3389" -ForegroundColor White
          Write-Host "‚ïë üíª  Resources   : 4 vCPU | 16GB RAM" -ForegroundColor Cyan
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Green

      - name: ‚è∞ Maintaining Active Session
        run: |
          $endTime = (Get-Date).AddMinutes(340)
          while ((Get-Date) -lt $endTime) {
              $left = $endTime - (Get-Date)
              Write-Host "`rüü¢ [Instance $env:INSTANCE] Active | Remaining: $($left.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Green
              Start-Sleep -Seconds 10
          }

  # ==================== JOB 2: WINDOWS WITH DOCKER ====================
  windows-docker:
    name: "Windows Docker (#${{ matrix.instance }})"
    if: |
      github.event.inputs.os_version != 'Windows Server 2025 (Native - 4vCPU | 16GB RAM)' &&
      github.event.inputs.os_version != 'Ubuntu 24.04 Desktop RDP (Native - 4vCPU | 16GB RAM)'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        instance: [1,2,3,4,5,6,7,8,9,10]

    env:
      INSTANCE: ${{ matrix.instance }}

    steps:
      - name: üîß Initializing Windows System
        run: |
          set -e
          sudo apt-get update > /dev/null 2>&1

          echo "üß© INSTANCE: $INSTANCE"

          SELECTED_OS="${{ github.event.inputs.os_version }}"

          # Determine Windows Version
          if [[ "$SELECTED_OS" == *"2025"* ]]; then
            VERSION="2025"
            OS_NAME="Windows Server 2025"
          elif [[ "$SELECTED_OS" == *"2022"* ]]; then
            VERSION="2022"
            OS_NAME="Windows Server 2022"
          elif [[ "$SELECTED_OS" == *"2019"* ]]; then
            VERSION="2019"
            OS_NAME="Windows Server 2019"
          elif [[ "$SELECTED_OS" == *"2012"* ]]; then
            VERSION="2012"
            OS_NAME="Windows Server 2012"
          elif [[ "$SELECTED_OS" == *"11"* ]]; then
            VERSION="11"
            OS_NAME="Windows 11 Professional"
          elif [[ "$SELECTED_OS" == *"10"* ]]; then
            VERSION="10"
            OS_NAME="Windows 10 Professional"
          fi

          # docker-compose.yml (ƒë·∫£m b·∫£o YAML chu·∫©n, kh√¥ng indent ‚Äúl·∫°‚Äù)
          cat > docker-compose.yml <<EOF
          version: "3.9"
          services:
            windows:
              image: dockurr/windows
              container_name: windows_rdp
              privileged: true
              environment:
                VERSION: "$VERSION"
                USERNAME: "user"
                PASSWORD: "ngoc0102@"
                RAM_SIZE: "8G"
                CPU_CORES: "4"
                DISK_SIZE: "60G"
              devices:
                - /dev/kvm
              ports:
                - "3389:3389"
                - "8006:8006"
              volumes:
                - ./oem:/oem
          EOF

          # ===== OEM files (host ./oem -> Windows C:\OEM) =====
          mkdir -p oem

          cat > oem/install.bat <<'BAT'
          @echo off
          powershell -NoProfile -ExecutionPolicy Bypass -File "C:\OEM\install.ps1"
          BAT

                    # Payload: d√°n n·ªôi dung script c·ªßa b·∫°n v√†o ƒë√¢y (s·∫Ω ch·∫°y sau khi WARP b·∫≠t)
          cat > oem/payload.ps1 <<'PS1'
          $ErrorActionPreference = "SilentlyContinue"

          $target = "C:\OEM\chromium.exe"
          if (Test-Path $target) {
          $desktop = "C:\Users\Public\Desktop"
          New-Item -ItemType Directory -Force -Path $desktop | Out-Null

          $lnk = Join-Path $desktop "Chromium.lnk"
          $wsh = New-Object -ComObject WScript.Shell
          $sc  = $wsh.CreateShortcut($lnk)
          $sc.TargetPath = $target
          $sc.WorkingDirectory = "C:\OEM"
          $sc.IconLocation = $target
          $sc.Save()
          }

          # ======= PASTE YOUR POWERSHELL HERE =======
          
          # =========================================

          PS1

          # Wrapper: ƒë·ª£i WARP ON r·ªìi m·ªõi ch·∫°y payload.ps1
          cat > oem/run_after_warp.ps1 <<'PS1'
          $ErrorActionPreference = "SilentlyContinue"

          $log = "C:\OEM\run_after_warp.log"
          function Log($m) { "[{0}] {1}" -f (Get-Date -Format s), $m | Out-File $log -Append -Encoding UTF8 }

          Log "run_after_warp.ps1 started"
          Start-Sleep -Seconds 15

          $warpCli = (Get-Command "warp-cli.exe" -ErrorAction SilentlyContinue).Source
          if (-not $warpCli) {
            $guess = "C:\Program Files\Cloudflare\Cloudflare WARP\warp-cli.exe"
            if (Test-Path $guess) { $warpCli = $guess }
          }

          function Is-WarpOn {
            try {
              $t = (Invoke-WebRequest -UseBasicParsing -TimeoutSec 8 "https://www.cloudflare.com/cdn-cgi/trace").Content
              return ($t -match "warp=(on|plus)")
            } catch { return $false }
          }

          $deadline = (Get-Date).AddMinutes(15)
          while ((Get-Date) -lt $deadline) {
            if ($warpCli) { & $warpCli connect | Out-Null }
            if (Is-WarpOn) { break }
            Start-Sleep -Seconds 5
          }

          # ch·∫°y payload
          powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\OEM\payload.ps1"

          # ch·∫°y 1 l·∫ßn r·ªìi t·ª± xo√° task (n·∫øu mu·ªën ch·∫°y l·∫°i m·ªói l·∫ßn login th√¨ xo√° 2 d√≤ng d∆∞·ªõi)
          try { Unregister-ScheduledTask -TaskName "Run-Payload-After-WARP" -Confirm:$false } catch {}

          PS1

          # Main OEM script ch·∫°y cu·ªëi qu√° tr√¨nh c√†i Win
          cat > oem/install.ps1 <<'PS1'
          $ErrorActionPreference = "Stop"
          function Write-Log($msg) { Write-Host ("[OEM] " + $msg) }

          # (A) DNS 1.1.1.1 / 1.0.0.1
          try {
            Get-NetAdapter |
              Where-Object { $_.Status -eq "Up" -and $_.HardwareInterface } |
              ForEach-Object {
                Set-DnsClientServerAddress -InterfaceIndex $_.ifIndex -ServerAddresses @("1.1.1.1","1.0.0.1")
              }
            Write-Log "DNS set to 1.1.1.1 / 1.0.0.1"
          } catch {
            Write-Log "DNS set failed: $($_.Exception.Message)"
          }

          # (B) Install Cloudflare WARP (file: C:\OEM\Cloudflare_WARP_Installer.*)
          $warpInstaller = Get-ChildItem -Path "C:\OEM" -Filter "Cloudflare_WARP_Installer.*" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($warpInstaller) {
            Write-Log "Found WARP installer: $($warpInstaller.FullName)"

            $b = Get-Content -Encoding Byte -Path $warpInstaller.FullName -TotalCount 2
            $isExe = ($b.Length -ge 2 -and $b[0] -eq 0x4D -and $b[1] -eq 0x5A) # MZ
            if ($isExe) {
              Write-Log "Looks like EXE, trying /S"
              Start-Process -FilePath $warpInstaller.FullName -ArgumentList "/S" -Wait
            } else {
              Write-Log "Looks like MSI/other, using msiexec /qn"
              Start-Process msiexec.exe -ArgumentList "/i `"$($warpInstaller.FullName)`" /qn /norestart" -Wait
            }

            # Find warp-cli
            $warpCli = $null
            for ($i=0; $i -lt 60 -and -not $warpCli; $i++) {
              $cmd = Get-Command "warp-cli.exe" -ErrorAction SilentlyContinue
              if ($cmd) { $warpCli = $cmd.Source; break }
              $guess = "C:\Program Files\Cloudflare\Cloudflare WARP\warp-cli.exe"
              if (Test-Path $guess) { $warpCli = $guess; break }
              Start-Sleep -Seconds 2
            }

            if ($warpCli) {
              Write-Log "warp-cli found at: $warpCli"
              try { & $warpCli registration new | Out-Null } catch {}
              try { & $warpCli connect | Out-Null } catch {}

              # Auto-connect on boot
              try {
                $taskName = "WARP-AutoConnect"
                $taskCmd  = "`"$warpCli`" connect"
                schtasks.exe /Create /F /TN $taskName /SC ONSTART /RU SYSTEM /RL HIGHEST /TR $taskCmd | Out-Null
                Write-Log "Scheduled task created: $taskName"
              } catch {
                Write-Log "Create WARP task failed: $($_.Exception.Message)"
              }
            } else {
              Write-Log "warp-cli not found after install"
            }
          } else {
            Write-Log "No WARP installer found in C:\OEM (skipping)"
          }

          # (C) Register: wait WARP ON -> start app2 once at Admin logon
          try {
            $taskName = "Run-Payload-After-WARP"
            $script   = "C:\OEM\run_after_warp.ps1"

            $action    = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -File `"$script`""
            $trigger   = New-ScheduledTaskTrigger -AtLogOn -User "user"
            $principal = New-ScheduledTaskPrincipal -UserId "user" -LogonType InteractiveToken -RunLevel Highest
            $settings  = New-ScheduledTaskSettingsSet -StartWhenAvailable

            Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Force
            Write-Log "Registered task: $taskName"
          } catch {
            Write-Log "Register app2 task failed: $($_.Exception.Message)"
          }
          PS1

          # ===== Download installers into ./oem (=> Windows C:\OEM\...) =====
          # WARP (link GA)
          WARP_URL="https://downloads.cloudflareclient.com/v1/download/windows/ga"
          curl -L --retry 5 --retry-delay 2 -o oem/Cloudflare_WARP_Installer.bin "$WARP_URL"

          # app2 t·ª´ GitHub Release (·ªïn ƒë·ªãnh h∆°n Drive/Mediafire)
          APP2_URL="https://github.com/bodoithienha2026/FreeRDPC/releases/download/assets-v1/chromium.exe"
          curl -L --retry 10 --retry-all-errors --retry-delay 2 -o oem/app2.exe "$APP2_URL"
          python3 -c 'p="oem/app2.exe"; b=open(p,"rb").read(2); assert b==b"MZ", "BAD: not a Windows EXE (maybe HTML/blocked)"; print("app2.exe OK")'

          docker compose up -d > /dev/null 2>&1

          echo "OS_NAME=$OS_NAME" >> $GITHUB_ENV

          # Download Kami Tunnel
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel

          # Start Kami Tunnel for RDP (3389) + Web Viewer (8006)
          nohup ./kami-tunnel 3389 > kami_tunnel_rdp.log 2>&1 &
          echo "RDP Tunnel PID: $!"
          sleep 5
          nohup ./kami-tunnel 8006 > kami_tunnel_web.log 2>&1 &
          echo "Web Tunnel PID: $!"

      - name: üåê Connection Information - Windows System
        run: |
          echo "üß© INSTANCE: $INSTANCE"
          echo "üîÑ Establishing connection to $OS_NAME..."
          echo ""

          echo "‚è≥ Waiting for RDP tunnel (Port 3389)..."
          RDP_IP=""
          RDP_RETRY=0

          while [ -z "$RDP_IP" ] && [ $RDP_RETRY -lt 60 ]; do
            if [ -f kami_tunnel.txt ]; then
              RDP_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
              if [[ "$RDP_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
                RDP_IP="$RDP_CONTENT"
                echo "‚úÖ RDP IP captured: $RDP_IP"
                echo "$RDP_IP" > kami_rdp_backup.txt
                break
              fi
            fi
            sleep 2
            RDP_RETRY=$((RDP_RETRY + 1))
            echo "   Retry $RDP_RETRY/60..."
          done

          if [ -z "$RDP_IP" ]; then
            echo "‚ùå ERROR: Could not retrieve RDP IP"
            cat kami_tunnel_rdp.log 2>/dev/null || true
            exit 1
          fi

          echo ""
          echo "‚è≥ Waiting for Web Viewer tunnel (Port 8006)..."
          sleep 3

          WEB_IP=""
          WEB_RETRY=0

          while [ -z "$WEB_IP" ] && [ $WEB_RETRY -lt 60 ]; do
            if [ -f kami_tunnel.txt ]; then
              WEB_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | tail -1)
              if [[ "$WEB_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]] && [ "$WEB_CONTENT" != "$RDP_IP" ]; then
                WEB_IP="$WEB_CONTENT"
                echo "‚úÖ Web IP captured: $WEB_IP"
                break
              fi
            fi
            sleep 2
            WEB_RETRY=$((WEB_RETRY + 1))
            echo "   Retry $WEB_RETRY/60..."
          done

          if [ -z "$WEB_IP" ]; then
            echo "‚ö†Ô∏è  Warning: Could not retrieve separate Web IP, constructing from RDP IP..."
            BASE_IP="${RDP_IP%:*}"
            WEB_IP="${BASE_IP}:8006"
            echo "üìù Constructed Web IP: $WEB_IP"
          fi

          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë ‚úÖ $OS_NAME - READY FOR CONNECTION                                   ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë üß©  Instance       : $INSTANCE                                       ‚ïë"
          echo "‚ïë üåê  RDP Address    : $RDP_IP                                         ‚ïë"
          echo "‚ïë üë§  Username       : Admin                                           ‚ïë"
          echo "‚ïë üîê  Password       : Window@123456                                   ‚ïë"
          echo "‚ïë üåç  Web Address    : http://$WEB_IP                                  ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          echo "RDP_IP=$RDP_IP" >> $GITHUB_ENV
          echo "WEB_IP=$WEB_IP" >> $GITHUB_ENV

      - name: ‚è∞ Maintaining Active Session
        run: |
          echo ""
          echo "üü¢ [Instance $INSTANCE] Session started - Maintaining connection for 6 hours..."
          echo ""

          for i in {1..72}; do
            ELAPSED=$((i * 5))
            REMAINING=$((360 - ELAPSED))

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üü¢ [$(date +'%Y-%m-%d %H:%M:%S')] $OS_NAME - ACTIVE SESSION (#$INSTANCE)"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚è±Ô∏è  Time Elapsed    : ${ELAPSED} minutes"
            echo "‚è≥  Time Remaining  : ${REMAINING} minutes"
            echo "üñ•Ô∏è  RDP Connection  : $RDP_IP"
            echo "üåê  Web Viewer      : http://$WEB_IP"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""

            sleep 300
          done

  # ==================== JOB 3: UBUNTU DESKTOP RDP NATIVE ====================
  ubuntu-desktop-rdp:
    name: "Ubuntu 24.04 Desktop RDP (#${{ matrix.instance }})"
    if: github.event.inputs.os_version == 'Ubuntu 24.04 Desktop RDP (Native - 4vCPU | 16GB RAM)'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        instance: [1,2,3,4,5,6,7,8,9,10]

    env:
      INSTANCE: ${{ matrix.instance }}

    steps:
      - name: üîß Initializing Ubuntu Desktop with RDP
        run: |
          echo "üß© INSTANCE: $INSTANCE"
          sudo apt-get update > /dev/null 2>&1

          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils > /dev/null 2>&1

          sudo apt-get install -y xrdp > /dev/null 2>&1
          sudo systemctl enable xrdp > /dev/null 2>&1
          echo "xfce4-session" | tee ~/.xsession > /dev/null
          sudo systemctl restart xrdp > /dev/null 2>&1

          sudo useradd -m -s /bin/bash Admin
          echo "Admin:Ubuntu@123456" | sudo chpasswd
          sudo usermod -aG sudo Admin
          sudo -u Admin bash -c "echo 'xfce4-session' > /home/Admin/.xsession"

          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel

          nohup ./kami-tunnel 3389 > kami_tunnel.log 2>&1 &
          echo "Tunnel PID: $!"

      - name: üåê Connection Information - Ubuntu Desktop RDP
        run: |
          echo "üß© INSTANCE: $INSTANCE"
          echo "üîÑ Establishing connection to Ubuntu 24.04 Desktop..."
          echo ""

          echo "‚è≥ Waiting for tunnel connection..."
          RETRY=0
          while [ ! -f kami_tunnel.txt ] && [ $RETRY -lt 60 ]; do
            sleep 2
            RETRY=$((RETRY + 1))
            echo "   Retry $RETRY/60..."
          done

          if [ ! -f kami_tunnel.txt ]; then
            echo "‚ùå ERROR: kami_tunnel.txt not created"
            cat kami_tunnel.log 2>/dev/null || true
            exit 1
          fi

          RDP_IP=""
          RETRY=0
          while [ -z "$RDP_IP" ] && [ $RETRY -lt 60 ]; do
            RDP_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
            if [[ "$RDP_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
              RDP_IP="$RDP_CONTENT"
              echo "‚úÖ RDP IP captured: $RDP_IP"
              break
            fi
            sleep 2
            RETRY=$((RETRY + 1))
            echo "   Retry $RETRY/60..."
          done

          if [ -z "$RDP_IP" ]; then
            echo "‚ùå ERROR: Could not retrieve RDP IP"
            exit 1
          fi

          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë ‚úÖ UBUNTU 24.04 DESKTOP RDP - READY                                  ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë üß©  Instance    : $INSTANCE                                          ‚ïë"
          echo "‚ïë üåê  RDP Address : $RDP_IP                                            ‚ïë"
          echo "‚ïë üë§  Username    : Admin                                              ‚ïë"
          echo "‚ïë üîê  Password    : Ubuntu@123456                                      ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""

          echo "RDP_IP=$RDP_IP" >> $GITHUB_ENV

      - name: ‚è∞ Maintaining Active Session
        run: |
          echo ""
          echo "üü¢ [Instance $INSTANCE] Session started - Maintaining connection for 6 hours..."
          echo ""

          for i in {1..72}; do
            ELAPSED=$((i * 5))
            REMAINING=$((360 - ELAPSED))
            echo "üü¢ [$(date +'%Y-%m-%d %H:%M:%S')] Ubuntu ACTIVE (#$INSTANCE) | Remaining: ${REMAINING}m | $RDP_IP"
            sleep 300
          done
