name: üöÄ WINDOWS & UBUNTU RDP

on: 
  workflow_dispatch:
    inputs:
      os_version:
        description: 'üìÄ Ch·ªçn h·ªá ƒëi·ªÅu h√†nh'
        required: true
        default: 'Windows Server 2025 (4vCPU | 16GB RAM)'
        type: choice
        options: 
          - "Windows Server 2025 (4vCPU | 16GB RAM)"
          - "Windows Server 2025 (4vCPU | 8GB RAM)"
          - "Windows Server 2022 (4vCPU | 8GB RAM)"
          - "Windows Server 2019 (4vCPU | 8GB RAM)"
          - "Windows Server 2012 (4vCPU | 8GB RAM)"
          - "Windows 11 (4vCPU | 8GB RAM)"
          - "Windows 10 (4vCPU | 8GB RAM)"
          - "Ubuntu 24.04 RDP (4vCPU | 8GB RAM)"

jobs:
  # Job 1: Windows Server 2025 Native (4vCPU | 16GB RAM)
  windows-native:
    if: github.event.inputs.os_version == 'Windows Server 2025 (4vCPU | 16GB RAM)'
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: üõ†Ô∏è ƒêANG KH·ªûI T·∫†O WINDOWS SERVER 2025 (4vCPU | 16GB RAM)
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          # 1. T·∫°o User Windows (User: Admin | Pass: Window@123456)
          net user Admin Window@123456 /add /expires:never /passwordchg:no
          net localgroup Administrators Admin /add
          net localgroup "Remote Desktop Users" Admin /add
          
          # 2. C·∫•u h√¨nh RDP h·ªá th·ªëng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          # 3. Ch·∫°y Kami Tunnel
          Start-Process powershell -ArgumentList "-NoProfile -Command `
            iwr https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz -OutFile kami-tunnel-windows-amd64.tar.gz; `
            tar -xzf kami-tunnel-windows-amd64.tar.gz; `
            .\kami-tunnel.exe 3389"

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI WINDOWS SERVER 2025
        if: github.event.inputs.os_version == 'Windows Server 2025 (4vCPU | 16GB RAM)'
        run: |
          Write-Host "üîÑ ƒêang ki·ªÉm tra h·ªá th·ªëng Windows Server 2025..." -ForegroundColor Cyan
          $ip = ""
          # V√≤ng l·∫∑p ch·ªù cho ƒë·∫øn khi kami_tunnel.txt c√≥ d·ªØ li·ªáu
          while (-not $ip) {
              if (Test-Path "kami_tunnel.txt") {
                  $content = Get-Content "kami_tunnel.txt"
                  if ($content -match '\.') { 
                      $ip = $content 
                  }
              }
              if (-not $ip) { Start-Sleep -Seconds 3 }
          }
          
          Write-Host "`n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Green
          Write-Host "‚îÇ      üéâ WINDOWS SERVER 2025 READY!                  ‚îÇ" -ForegroundColor Green
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor White
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ IP : $ip" -ForegroundColor Yellow
          Write-Host "‚îÇ üë§  T√†i kho·∫£n  : Admin" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u   : Window@123456" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port       : 3389" -ForegroundColor White
          Write-Host "‚îÇ üíª  C·∫•u h√¨nh   : 4 vCPU | 16GB RAM" -ForegroundColor Cyan
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`n" -ForegroundColor Green

      - name: ‚è≥ DUY TR√å PHI√äN WINDOWS SERVER 2025
        if: github.event.inputs.os_version == 'Windows Server 2025 (4vCPU | 16GB RAM)'
        run: |
          $endTime = (Get-Date).AddMinutes(340)
          while ((Get-Date) -lt $endTime) {
              $left = $endTime - (Get-Date)
              Write-Host "`rüíé Windows Server 2025 (4vCPU | 16GB RAM) ƒëang ch·∫°y... C√≤n l·∫°i: $($left.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Magenta
              Start-Sleep -Seconds 10
          }

  # Job 2: Windows/Ubuntu v·ªõi Docker (4vCPU | 8GB RAM)
  docker-systems:
    if: github.event.inputs.os_version != 'Windows Server 2025 (4vCPU | 16GB RAM)'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: üõ†Ô∏è ƒêANG KH·ªûI T·∫†O H·ªÜ TH·ªêNG
        run: |
          sudo apt-get update > /dev/null 2>&1
          
          # X√°c ƒë·ªãnh h·ªá ƒëi·ªÅu h√†nh
          SELECTED_OS="${{ github.event.inputs.os_version }}"
          
          if [[ "$SELECTED_OS" == *"Ubuntu"* ]]; then
            # C√†i ƒë·∫∑t Ubuntu Desktop + RDP
            sudo apt-get install -y ubuntu-desktop xrdp > /dev/null 2>&1
            sudo systemctl enable xrdp > /dev/null 2>&1
            sudo systemctl start xrdp > /dev/null 2>&1
            
            # T·∫°o user Admin
            sudo useradd -m -s /bin/bash Admin
            echo "Admin:Ubuntu@123456" | sudo chpasswd
            sudo usermod -aG sudo Admin
            
            OS_NAME="Ubuntu 24.04 RDP"
            USERNAME="Admin"
            PASSWORD="Ubuntu@123456"
          else
            # Windows v·ªõi Docker
            if [[ "$SELECTED_OS" == *"2025"* ]]; then
              VERSION="2025"
              OS_NAME="Windows Server 2025"
            elif [[ "$SELECTED_OS" == *"2022"* ]]; then
              VERSION="2022"
              OS_NAME="Windows Server 2022"
            elif [[ "$SELECTED_OS" == *"2019"* ]]; then
              VERSION="2019"
              OS_NAME="Windows Server 2019"
            elif [[ "$SELECTED_OS" == *"2012"* ]]; then
              VERSION="2012"
              OS_NAME="Windows Server 2012"
            elif [[ "$SELECTED_OS" == *"11"* ]]; then
              VERSION="11"
              OS_NAME="Windows 11"
            elif [[ "$SELECTED_OS" == *"10"* ]]; then
              VERSION="10"
              OS_NAME="Windows 10"
            fi
            
            cat <<EOF > docker-compose.yml
          version: "3.9"
          services:
            windows:
              image: dockurr/windows
              container_name: windows
              privileged: true
              environment:
                VERSION: "$VERSION"
                USERNAME: "Admin"
                PASSWORD: "Window@123456"
                RAM_SIZE: "8G"
                CPU_CORES: "4"
                DISK_SIZE: "60G"
              devices: [ "/dev/kvm" ]
              ports:
                - "3389:3389"
          EOF
            docker compose up -d > /dev/null 2>&1
            USERNAME="Admin"
            PASSWORD="Window@123456"
          fi
          
          # L∆∞u th√¥ng tin v√†o ENV
          echo "OS_NAME=$OS_NAME" >> $GITHUB_ENV
          echo "USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV
          
          # T·∫£i v√† ch·∫°y Kami Tunnel
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          ./kami-tunnel 3389 > /dev/null 2>&1 &

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI H·ªÜ TH·ªêNG
        run: |
          echo "üîÑ ƒêang ki·ªÉm tra t√≠n hi·ªáu t·ª´ $OS_NAME (4vCPU | 8GB RAM)..."
          
          # V√≤ng l·∫∑p ch·ªù cho ƒë·∫øn khi c√≥ file IP
          while [ ! -f kami_tunnel.txt ]; do sleep 2; done
          
          # ƒê·ª£i file c√≥ n·ªôi dung IP
          RDP_IP=""
          while [ -z "$RDP_IP" ]; do
            RDP_IP=$(cat kami_tunnel.txt)
            sleep 2
          done

          echo ""
          echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
          echo "‚îÇ            üéâ $OS_NAME READY!                    ‚îÇ"
          echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
          echo "‚îÇ üåê ƒê·ªãa ch·ªâ IP : $RDP_IP"
          echo "‚îÇ üë§ T√†i kho·∫£n  : $USERNAME"
          echo "‚îÇ üîê M·∫≠t kh·∫©u   : $PASSWORD"
          echo "‚îÇ üìç C·ªïng RDP   : 3389"
          echo "‚îÇ üíª C·∫•u h√¨nh   : 4 vCPU | 8GB RAM"
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
          echo ""
          echo "KAMI_IP=$RDP_IP" >> $GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN H·ªÜ TH·ªêNG
        run: |
          for i in {1..72}; do
            echo "üíé [$(date +%H:%M:%S)] $OS_NAME (4vCPU | 8GB RAM) ƒëang ch·∫°y. IP: $KAMI_IP"
            sleep 300
          done
