name: üöÄ WINDOWS SERVER

on: 
  workflow_dispatch:
    inputs:
      win_version:
        description: 'üìÄ Ch·ªçn phi√™n b·∫£n Windows'
        required: true
        default: '2025-docker'
        type: choice
        options: 
          - "2025-native"
          - "2025-docker"
          - "2022"
          - "2019"
          - "2012"
          - "11"
          - "10"

jobs:
  # Job 1: Windows Server 2025 Native (4vCPU | 16GB RAM)
  windows-native:
    if: github.event.inputs.win_version == '2025-native'
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: üõ†Ô∏è ƒêANG KH·ªûI T·∫†O WINDOWS SERVER 2025 (4vCPU | 16GB RAM)
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          # 1. T·∫°o User Windows (Pass: window@123456)
          net user windows window@123456 /add /expires:never /passwordchg:no
          net localgroup Administrators windows /add
          net localgroup "Remote Desktop Users" windows /add
          
          # 2. C·∫•u h√¨nh RDP h·ªá th·ªëng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          # 3. Ch·∫°y Kami Tunnel
          Start-Process powershell -ArgumentList "-NoProfile -Command `
            iwr https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz -OutFile kami-tunnel-windows-amd64.tar.gz; `
            tar -xzf kami-tunnel-windows-amd64.tar.gz; `
            .\kami-tunnel.exe 3389"

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI WINDOWS SERVER 2025 (Native)
        if: github.event.inputs.win_version == '2025-native'
        run: |
          Write-Host "üîÑ ƒêang ki·ªÉm tra h·ªá th·ªëng Windows Server 2025 (4vCPU | 16GB RAM)..." -ForegroundColor Cyan
          $ip = ""
          # V√≤ng l·∫∑p ch·ªù cho ƒë·∫øn khi kami_tunnel.txt c√≥ d·ªØ li·ªáu
          while (-not $ip) {
              if (Test-Path "kami_tunnel.txt") {
                  $content = Get-Content "kami_tunnel.txt"
                  if ($content -match '\.') { 
                      $ip = $content 
                  }
              }
              if (-not $ip) { Start-Sleep -Seconds 3 }
          }
          
          # Ch·ªâ hi·ªán b·∫£ng n√†y khi ƒë√£ c√≥ IP ƒë·∫ßy ƒë·ªß
          Write-Host "`n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Green
          Write-Host "‚îÇ    üéâ WINDOWS SERVER 2025 READY! (4vCPU | 16GB RAM) ‚îÇ" -ForegroundColor Green
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor White
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ IP : $ip" -ForegroundColor Yellow
          Write-Host "‚îÇ üë§  T√†i kho·∫£n  : windows" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u   : window@123456" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port       : 3389" -ForegroundColor White
          Write-Host "‚îÇ üíª  C·∫•u h√¨nh   : 4 vCPU | 16GB RAM" -ForegroundColor Cyan
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`n" -ForegroundColor Green

      - name: ‚è≥ DUY TR√å PHI√äN WINDOWS (Native)
        if: github.event.inputs.win_version == '2025-native'
        run: |
          $endTime = (Get-Date).AddMinutes(340)
          while ((Get-Date) -lt $endTime) {
              $left = $endTime - (Get-Date)
              Write-Host "`rüíé Windows Server 2025 (4vCPU | 16GB RAM) ƒëang ch·∫°y... C√≤n l·∫°i: $($left.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Magenta
              Start-Sleep -Seconds 10
          }

  # Job 2: Windows Server v·ªõi Docker (4vCPU | 8GB RAM)
  windows-docker:
    if: github.event.inputs.win_version != '2025-native'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: üõ†Ô∏è ƒêANG KH·ªûI T·∫†O WINDOWS SERVER (4vCPU | 8GB RAM)
        run: |
          # Ch·∫°y ·∫©n to√†n b·ªô qu√° tr√¨nh c√†i ƒë·∫∑t
          sudo apt-get update > /dev/null 2>&1
          
          # X√°c ƒë·ªãnh version name
          VERSION="${{ github.event.inputs.win_version }}"
          if [ "$VERSION" = "2025-docker" ]; then
            VERSION="2025"
          fi
          
          cat <<EOF > docker-compose.yml
          version: "3.9"
          services:
            windows:
              image: dockurr/windows
              container_name: windows
              privileged: true
              environment:
                VERSION: "$VERSION"
                USERNAME: "windows"
                PASSWORD: "window@123456"
                RAM_SIZE: "8G"
                CPU_CORES: "4"
                DISK_SIZE: "60G"
              devices: [ "/dev/kvm" ]
              ports:
                - "3389:3389"
          EOF
          docker compose up -d > /dev/null 2>&1
          
          # T·∫£i Kami Tunnel ·∫©n danh
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          
          # Ch·∫°y Kami Tunnel
          ./kami-tunnel 3389 > /dev/null 2>&1 &

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI WINDOWS SERVER (Docker)
        run: |
          VERSION="${{ github.event.inputs.win_version }}"
          if [ "$VERSION" = "2025-docker" ]; then
            VERSION_NAME="2025"
          else
            VERSION_NAME="$VERSION"
          fi
          
          echo "üîÑ ƒêang ki·ªÉm tra t√≠n hi·ªáu t·ª´ Windows Server $VERSION_NAME (4vCPU | 8GB RAM)..."
          
          # V√≤ng l·∫∑p ch·ªù cho ƒë·∫øn khi c√≥ file IP
          while [ ! -f kami_tunnel.txt ]; do sleep 2; done
          
          # ƒê·ª£i file c√≥ n·ªôi dung IP
          RDP_IP=""
          while [ -z "$RDP_IP" ]; do
            RDP_IP=$(cat kami_tunnel.txt)
            sleep 2
          done

          echo ""
          echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
          echo "‚îÇ    üéâ WINDOWS SERVER $VERSION_NAME READY! (4vCPU | 8GB RAM)    ‚îÇ"
          echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
          echo "‚îÇ üåê ƒê·ªãa ch·ªâ IP : $RDP_IP"
          echo "‚îÇ üë§ T√†i kho·∫£n  : windows"
          echo "‚îÇ üîê M·∫≠t kh·∫©u   : window@123456"
          echo "‚îÇ üìç C·ªïng RDP   : 3389"
          echo "‚îÇ üíª C·∫•u h√¨nh   : 4 vCPU | 8GB RAM"
          echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
          echo ""
          echo "KAMI_IP=$RDP_IP" >> $GITHUB_ENV
          echo "WIN_VERSION=$VERSION_NAME" >> $GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN WINDOWS (Docker)
        run: |
          # Gi·ªØ workflow ch·∫°y v√† update log ng·∫Øn g·ªçn
          for i in {1..72}; do
            echo "üíé [$(date +%H:%M:%S)] Windows Server $WIN_VERSION (4vCPU | 8GB RAM) ƒëang ch·∫°y. IP: $KAMI_IP"
            sleep 300
          done
