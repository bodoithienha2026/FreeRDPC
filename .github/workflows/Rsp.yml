name: ğŸš€ SEVER WINDOWS PRO (KAMI TUNNEL)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ•’ Thá»i gian treo mÃ¡y (Max 6h)'
        required: true
        default: '6h'
        type: choice
        options: ['6h']

jobs:
  Windows-Server-RDP:
    runs-on: windows-latest
    
    steps:
      # 1. Cáº¤U HÃŒNH USER VÃ€ RDP
      - name: ğŸ› ï¸ CÃ i Ä‘áº·t Há»‡ thá»‘ng & User
        run: |
          Write-Host "--------------------------------------------"
          Write-Host "ğŸ‘¤ ÄANG Cáº¤U HÃŒNH TÃ€I KHOáº¢N ADMIN..." -ForegroundColor Yellow
          
          # Äáº·t máº­t kháº©u cho User Admin máº·c Ä‘á»‹nh (runneradmin)
          net user runneradmin 123456
          
          # Báº­t RDP, Táº¯t xÃ¡c thá»±c NLA (Ä‘á»ƒ dá»… káº¿t ná»‘i), Má»Ÿ Firewall
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          Write-Host "âœ… User: runneradmin | Pass: 123456" -ForegroundColor Green
          Write-Host "âœ… ÄÃ£ má»Ÿ cáº¥u hÃ¬nh RDP thÃ nh cÃ´ng!" -ForegroundColor Green
          Write-Host "--------------------------------------------"

      # 2. Táº¢I VÃ€ CHáº Y KAMI TUNNEL (WINDOWS)
      - name: ğŸŒ Khá»Ÿi cháº¡y Kami Tunnel
        run: |
          Write-Host "ğŸ“¥ Äang táº£i Kami Tunnel (Windows)..." -ForegroundColor Cyan
          
          # Táº£i file
          Invoke-WebRequest -Uri "https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz" -OutFile "kami.tar.gz"
          
          # Giáº£i nÃ©n
          tar -xzf kami.tar.gz
          
          # Cháº¡y Tunnel áº©n (Start-Process Ä‘á»ƒ khÃ´ng bá»‹ treo script)
          Write-Host "ğŸš€ Äang kÃ­ch hoáº¡t Tunnel..." -ForegroundColor Yellow
          Start-Process -FilePath ".\kami-tunnel.exe" -ArgumentList "3389" -NoNewWindow
          
          # Äá»£i 5 giÃ¢y Ä‘á»ƒ file txt ká»‹p táº¡o ra
          Start-Sleep -Seconds 5
          
          # Kiá»ƒm tra file vÃ  Ä‘á»c IP
          if (Test-Path "kami_tunnel.txt") {
              $ip = Get-Content "kami_tunnel.txt"
              echo "RDP_IP=$ip" >> $env:GITHUB_ENV
              Write-Host "âœ… ÄÃ£ láº¥y Ä‘Æ°á»£c IP thÃ nh cÃ´ng!" -ForegroundColor Green
          } else {
              Write-Host "âŒ KhÃ´ng tÃ¬m tháº¥y file IP. Vui lÃ²ng kiá»ƒm tra láº¡i Tunnel." -ForegroundColor Red
          }

      # 3. HIá»‚N THá»Š THÃ”NG TIN VÃ€ TREO MÃY
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $ip = $env:RDP_IP
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚           ğŸš€ WINDOWS SERVER READY           â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸ–¥ï¸  IP Káº¿t Ná»‘i : $ip" -ForegroundColor Green
          Write-Host "â”‚ ğŸ‘¤  User       : runneradmin" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Password   : 123456" -ForegroundColor White
          Write-Host "â”‚ ğŸ•’  Thá»i gian  : 6 Giá»" -ForegroundColor White
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ âš ï¸  LÆ°u Ã½: Copy IP trÃªn dÃ¡n vÃ o RDP        â”‚" -ForegroundColor Yellow
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          Write-Host ""

          # VÃ²ng láº·p giá»¯ káº¿t ná»‘i Ä‘áº¹p (Treo mÃ¡y 6 tiáº¿ng)
          # Log sáº½ hiá»‡n má»—i 2 phÃºt má»™t láº§n Ä‘á»ƒ khÃ´ng bá»‹ spam
          $seconds = 21600
          while ($seconds -gt 0) {
              if ($seconds % 120 -eq 0) {
                  $timestamp = Get-Date -Format "HH:mm:ss"
                  Write-Host "ğŸ’ [$timestamp] Há»‡ thá»‘ng Ä‘ang hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh... IP: $ip" -ForegroundColor Magenta
              }
              Start-Sleep -Seconds 1
              $seconds--
          }
