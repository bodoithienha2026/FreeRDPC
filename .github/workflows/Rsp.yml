name: ğŸš€ WINDOWS SERVER 2025

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Windows-Setup:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # BÆ°á»›c nÃ y cháº¡y áº©n táº¥t cáº£ cáº¥u hÃ¬nh Ä‘á»ƒ sáº¡ch log
      - name: ğŸ› ï¸ ÄANG KHá»I Táº O WINDOWS SERVER 2025
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          # 1. Táº¡o User Windows (Pass: window@123456)
          net user windows window@123456 /add /expires:never /passwordchg:no
          net localgroup Administrators windows /add
          net localgroup "Remote Desktop Users" windows /add
          
          # 2. Cáº¥u hÃ¬nh RDP há»‡ thá»‘ng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          # 3. Cháº¡y Ä‘Ãºng chuá»—i lá»‡nh cá»§a báº¡n báº±ng Start-Process Ä‘á»ƒ áº©n log vÃ  khÃ´ng nháº£y port 80
          Start-Process powershell -ArgumentList "-NoProfile -Command `
            iwr https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz -OutFile kami-tunnel-windows-amd64.tar.gz; `
            tar -xzf kami-tunnel-windows-amd64.tar.gz; `
            .\kami-tunnel.exe 3389"

      # BÆ°á»›c duy nháº¥t hiá»ƒn thá»‹ khi Ä‘Ã£ cÃ³ Ä‘áº§y Ä‘á»§ thÃ´ng tin
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I WINDOWS
        run: |
          Write-Host "ğŸ”„ Äang kiá»ƒm tra há»‡ thá»‘ng Windows Server 2025..." -ForegroundColor Cyan
          $ip = ""
          # VÃ²ng láº·p chá» cho Ä‘áº¿n khi kami_tunnel.txt cÃ³ dá»¯ liá»‡u
          while (-not $ip) {
              if (Test-Path "kami_tunnel.txt") {
                  $content = Get-Content "kami_tunnel.txt"
                  if ($content -match '\.') { 
                      $ip = $content 
                  }
              }
              if (-not $ip) { Start-Sleep -Seconds 3 }
          }
          
          # Chá»‰ hiá»‡n báº£ng nÃ y khi Ä‘Ã£ cÃ³ IP Ä‘áº§y Ä‘á»§
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Green
          Write-Host "â”‚        ğŸ‰ WINDOWS SERVER 2025 READY!      â”‚" -ForegroundColor Green
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor White
          Write-Host "â”‚ ğŸŒ  Äá»‹a chá»‰ IP : $ip" -ForegroundColor Yellow
          Write-Host "â”‚ ğŸ‘¤  TÃ i khoáº£n  : windows" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Máº­t kháº©u   : window@123456" -ForegroundColor White
          Write-Host "â”‚ ğŸ“  Port       : 3389" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`n" -ForegroundColor Green

      - name: â³ DUY TRÃŒ PHIÃŠN WINDOWS
        run: |
          $endTime = (Get-Date).AddMinutes(340)
          while ((Get-Date) -lt $endTime) {
              $left = $endTime - (Get-Date)
              Write-Host "`rğŸ’ Windows Server 2025 Ä‘ang cháº¡y... CÃ²n láº¡i: $($left.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Magenta
              Start-Sleep -Seconds 10
          }
