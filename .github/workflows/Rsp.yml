name: ğŸš€ SEVER AI STV PREMIUM (KAMI NATIVE)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # 1. BANNER CHÃ€O Má»ªNG (Giá»¯ phong cÃ¡ch cá»§a báº¡n)
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host "`nğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}`n" -ForegroundColor Magenta
          $frames = @('â£¾', 'â£½', 'â£»', 'â¢¿', 'â¡¿', 'â£Ÿ', 'â£¯', 'â£·')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!                    " -ForegroundColor Green

      # 2. Cáº¤U HÃŒNH RDP & Táº O USER ADMIN
      - name: ğŸ‘¤ Cáº¤U HÃŒNH USER ADMIN & Cá»”NG RDP
        run: |
          Write-Host "`nğŸ› ï¸  ÄANG THIáº¾T Láº¬P USER VÃ€ Má» Cá»”NG RDP..." -ForegroundColor Yellow
          
          # Táº¡o User Admin / Máº­t kháº©u window@123456
          $name = "Admin"
          $pass = "window@123456"
          net user $name $pass /add /expires:never /passwordchg:no
          net localgroup Administrators $name /add
          net localgroup "Remote Desktop Users" $name /add
          
          # Má»Ÿ cá»•ng RDP trong Registry
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1 -Force
          
          # Má»Ÿ Firewall cá»•ng 3389
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          Write-Host "â”‚ âœ… ÄÃ£ táº¡o User: $name" -ForegroundColor Green
          Write-Host "â”‚ âœ… ÄÃ£ má»Ÿ cá»•ng RDP (3389)" -ForegroundColor Green

      # 3. KÃCH HOáº T KAMI TUNNEL (Láº¥y IP Public)
      - name: ğŸŒ KÃCH HOáº T KAMI TUNNEL
        run: |
          Write-Host "`nğŸŒ ÄANG Táº¢I VÃ€ CHáº Y KAMI TUNNEL..." -ForegroundColor Yellow
          Invoke-WebRequest -Uri "https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz" -OutFile "kami.tar.gz"
          tar -xzf kami.tar.gz
          
          # Cháº¡y Tunnel cá»•ng 3389
          Start-Process -FilePath ".\kami-tunnel.exe" -ArgumentList "3389" -NoNewWindow
          
          # VÃ²ng láº·p chá» file IP (Ä‘á»ƒ Ä‘áº£m báº£o IP hiá»‡n Ä‘áº§y Ä‘á»§)
          Write-Host "ğŸ”„ Äang chá» láº¥y IP Public..." -NoNewline -ForegroundColor Cyan
          $ip = ""
          for($i=0; $i -lt 15; $i++) {
              if (Test-Path "kami_tunnel.txt") {
                  $ip = Get-Content "kami_tunnel.txt"
                  if ($ip -ne $null -and $ip -match '\.') {
                      echo "KAMI_IP=$ip" >> $env:GITHUB_ENV
                      Write-Host "`râœ… ÄÃ£ láº¥y Ä‘Æ°á»£c IP thÃ nh cÃ´ng!" -ForegroundColor Green
                      break
                  }
              }
              Write-Host "." -NoNewline -ForegroundColor Cyan
              Start-Sleep -Seconds 2
          }

      # 4. HIá»‚N THá»Š THÃ”NG TIN (Giao diá»‡n khung cá»§a báº¡n)
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚              ğŸ‰ Káº¾T Ná»I THÃ€NH CÃ”NG!              â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ  IP Káº¿t Ná»‘i : $env:KAMI_IP" -ForegroundColor Yellow
          Write-Host "â”‚ ğŸ‘¤  User       : Admin" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Password   : window@123456" -ForegroundColor White
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸ’¡ HÆ°á»›ng dáº«n: Má»Ÿ RDP, nháº­p IP vÃ  User/Pass  â”‚" -ForegroundColor Yellow
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`n" -ForegroundColor Cyan

      # 5. DUY TRÃŒ PHIÃŠN (TIMER)
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $totalMin = if("${{ github.event.inputs.duration }}" -eq "1h") {60} elseif("${{ github.event.inputs.duration }}" -eq "3h") {180} else {340}
          $endTime = (Get-Date).AddMinutes($totalMin)
          $frames = @('â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â ')
          
          while ((Get-Date) -lt $endTime) {
              $timeLeft = $endTime - (Get-Date)
              $frame = $frames[(Get-Date).Second % $frames.Length]
              Write-Host "`r$frame [$(Get-Date -Format 'HH:mm:ss')] IP: $env:KAMI_IP | User: Admin | CÃ²n láº¡i: $($timeLeft.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Magenta
              Start-Sleep -Seconds 1
          }
