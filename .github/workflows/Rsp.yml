name: ğŸš€ SEVER AI STV PREMIUM (FIX PORT 80)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # 1. Táº O USER ADMIN (ÄÃºng máº­t kháº©u báº¡n yÃªu cáº§u)
      - name: ğŸ‘¤ THIáº¾T Láº¬P TÃ€I KHOáº¢N ADMIN
        run: |
          Write-Host "ğŸ› ï¸  ÄANG Táº O USER: Admin..." -ForegroundColor Yellow
          net user Admin window@123456 /add /expires:never /passwordchg:no
          net localgroup Administrators Admin /add
          net localgroup "Remote Desktop Users" Admin /add
          
          # Má»Ÿ cá»•ng RDP trÃªn há»‡ thá»‘ng
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 profile=any
          Write-Host "âœ… ÄÃ£ táº¡o User Admin thÃ nh cÃ´ng!" -ForegroundColor Green

      # 2. CHáº Y KAMI TUNNEL (DÃ¹ng CMD Ä‘á»ƒ khÃ´ng bá»‹ lá»—i port 80)
      - name: ğŸŒ KÃCH HOáº T KAMI TUNNEL
        shell: cmd
        run: |
          echo ğŸŒ ÄANG Táº¢I KAMI...
          curl -L -o kami-tunnel-windows-amd64.tar.gz https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-windows-amd64.tar.gz
          
          echo ğŸ“¦ GIáº¢I NÃ‰N...
          tar -xzf kami-tunnel-windows-amd64.tar.gz
          
          echo ğŸš€ CHáº Y Lá»†NH: kami-tunnel.exe 3389
          :: Sá»­ dá»¥ng 'start' Ä‘á»ƒ cháº¡y lá»‡nh cá»§a báº¡n mÃ  khÃ´ng lÃ m Ä‘á»©ng script, giÃºp hiá»‡n IP bÃªn dÆ°á»›i
          start kami-tunnel.exe 3389

      # 3. HIá»‚N THá»Š THÃ”NG TIN Káº¾T Ná»I
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          Write-Host "`nğŸ”„ Äang láº¥y IP tá»« Kami Tunnel..." -ForegroundColor Cyan
          $ip = ""
          # VÃ²ng láº·p chá» file IP (15 láº§n, má»—i láº§n 2 giÃ¢y)
          for($i=0; $i -lt 15; $i++) {
              if (Test-Path "kami_tunnel.txt") {
                  $ip = Get-Content "kami_tunnel.txt"
                  if ($ip -and $ip -match '\.') {
                      echo "KAMI_IP=$ip" >> $env:GITHUB_ENV
                      break
                  }
              }
              Start-Sleep -Seconds 2
          }
          
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚              ğŸ‰ RDP ÄÃƒ Sáº´N SÃ€NG!                 â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ  IP Káº¿t Ná»‘i : $ip" -ForegroundColor Yellow
          Write-Host "â”‚ ğŸ‘¤  User       : Admin" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Password   : window@123456" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`n" -ForegroundColor Cyan

      # 4. DUY TRÃŒ PHIÃŠN (Äáº¿m ngÆ°á»£c thá»i gian)
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $totalMin = if("${{ github.event.inputs.duration }}" -eq "1h") {60} elseif("${{ github.event.inputs.duration }}" -eq "3h") {180} else {340}
          $endTime = (Get-Date).AddMinutes($totalMin)
          while ((Get-Date) -lt $endTime) {
              $left = $endTime - (Get-Date)
              Write-Host "`rğŸ’ IP: $env:KAMI_IP | Admin | CÃ²n láº¡i: $($left.ToString('hh\:mm\:ss'))" -NoNewline -ForegroundColor Magenta
              Start-Sleep -Seconds 1
          }
